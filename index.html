<!doctype html>
<html lang="ms">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>For Fadhlin — Breathe & Bloom (3× 4-7-8)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg1:#fff7fb; --bg2:#ffe9f6;
        --text:#161617; --muted:#6a6a6a;
        --pink:#ff4fa0; --pink-soft:#ff86bf;
        --purple:#9b5de5; --purple-dark:#7b3ad7;
      }
      *{box-sizing:border-box}
      html,body{height:100%;margin:0}
      body{
        font-family:Quicksand, system-ui, Segoe UI, Arial, sans-serif;
        background:radial-gradient(80% 80% at 50% 20%, var(--bg2), var(--bg1));
        color:var(--text); overflow:hidden;
        -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      }
      .wrap{position:fixed; inset:0; display:grid; place-items:center; padding:16px}
      .card{
        position:relative; width:min(840px, 92vw); border-radius:22px;
        background:#fff; box-shadow:0 16px 40px rgba(0,0,0,.12);
        padding:28px 18px 22px; overflow:hidden;
      }

      .title{
        font-family:"Dancing Script", cursive; font-weight:700;
        font-size:clamp(28px,6.4vw,56px); line-height:1.1;
        color:var(--pink); text-align:center; margin:4px 8px 8px;
        text-shadow:0 0 18px rgba(255,79,160,.22);
        animation:fadeDown .7s ease-out both;
      }
      @keyframes fadeDown{ from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)} }

      .sub{ text-align:center; font-weight:700; color:var(--pink-soft); margin:0 0 6px; }
      .hint{ text-align:center; font-size:12px; color:#8a5fb3; margin:0 0 10px } /* sweet hint */

      .zone{
        position:relative; display:grid; place-items:center;
        height:min(54vh, 500px); margin:6px 0 8px; z-index:1;
        padding:4px;
      }

      /* bunga */
      .flowerWrap{
        transform:scale(var(--base, .8)); transition:transform .8s cubic-bezier(.25,.8,.25,1);
        filter:drop-shadow(0 14px 28px rgba(155,93,229,.22));
        will-change:transform;
      }
      .flower{
        width:min(360px, 70vmin); aspect-ratio:1/1; position:relative;
        opacity:.98;
      }
      .petal{
        position:absolute; inset:0; display:grid; place-items:center;
        transform:rotate(var(--r,0deg));
      }
      .petal > span{
        width:52%; height:52%;
        border-radius:45% 55% 45% 55% / 55% 45% 55% 45%;
        background:
          radial-gradient(ellipse at 30% 30%, #fff 0 18%, transparent 19%),
          radial-gradient(circle at 70% 70%, rgba(255,255,255,.4) 0 18%, transparent 19%),
          linear-gradient(180deg, rgba(155,93,229,.88), rgba(155,93,229,.68));
        box-shadow:inset 0 0 10px rgba(255,255,255,.25);
      }
      .centerDot{ position:absolute; inset:0; display:grid; place-items:center }
      .centerDot::before{
        content:""; width:22%; aspect-ratio:1; border-radius:50%;
        background:radial-gradient(circle at 35% 35%, #ffe 0 20%, transparent 21%), #7b3ad7;
        box-shadow:0 4px 12px rgba(0,0,0,.15) inset;
      }
      .ring{ position:absolute; inset:6%; border-radius:50%; border:2px dashed rgba(123,58,215,.2) }

      /* teks fasa & mesej */
      .phase{ margin-top:10px; text-align:center; font-weight:700; }
      .phase b{ color:var(--purple-dark) }
      .affirm{ text-align:center; font-size:14px; color:#4a4a4a; margin-top:6px; min-height:1.5em }

      .controls{ display:flex; justify-content:center; gap:10px; margin-top:12px; flex-wrap:wrap }
      .btn{
        background:linear-gradient(180deg, #ff8ec4, #ff5ea8);
        color:#fff; border:none; border-radius:999px; padding:10px 16px;
        font-weight:700; cursor:pointer; box-shadow:0 10px 20px rgba(255,94,168,.25);
      }
      .btn.secondary{
        background:#fff; color:#ff5ea8; border:2px solid #ff5ea8;
      }
      .btn:active{ transform:translateY(1px) }

      .meters{
        display:flex; gap:14px; justify-content:center; align-items:center;
        margin-top:6px; flex-wrap:wrap; color:#6a6a6a; font-size:12px;
      }
      .count b{ color:var(--pink) }

      @media (max-width:520px){
        .card{border-radius:18px}
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1 class="title">Semangat Fadhlin</h1>
        <p class="sub">Be happy</p>
        <p class="hint">There is someone who always wants you to be happy.</p>

        <div class="zone" id="zone">
          <div class="flowerWrap" id="flowerWrap" style="--base:.8">
            <div class="flower" id="flower" aria-label="Breathing flower">
              <!-- 8 kelopak -->
              <div class="petal" style="--r:0deg"><span></span></div>
              <div class="petal" style="--r:45deg"><span></span></div>
              <div class="petal" style="--r:90deg"><span></span></div>
              <div class="petal" style="--r:135deg"><span></span></div>
              <div class="petal" style="--r:180deg"><span></span></div>
              <div class="petal" style="--r:225deg"><span></span></div>
              <div class="petal" style="--r:270deg"><span></span></div>
              <div class="petal" style="--r:315deg"><span></span></div>
              <div class="centerDot"></div>
              <div class="ring"></div>
            </div>
          </div>
        </div>

        <div class="phase" id="phase">Take a short rest. Let’s have three good breaths.</div>
        <div class="affirm" id="affirm"></div>

        <div class="controls">
          <button class="btn" id="startBtn">Start</button>
          <button class="btn secondary" id="pauseBtn" disabled>Pause</button>
          <button class="btn secondary" id="resetBtn">Reset</button>
        </div>
        <div class="meters">
          <div class="count" id="countLabel">Count breath: <b id="countNum">0</b>/3</div>
          <div class="count" id="meter">Bloom level: 0%</div>
        </div>
      </div>
    </div>

    <script>
      const zone = document.getElementById('zone');
      const wrap = document.getElementById('flowerWrap');
      const phaseEl = document.getElementById('phase');
      const affirmEl = document.getElementById('affirm');
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const resetBtn = document.getElementById('resetBtn');
      const meterEl = document.getElementById('meter');
      const countNumEl = document.getElementById('countNum');

      // Timing 4-7-8
      const inhale = 4000, hold = 7000, exhale = 8000;

      // Bloom cumulative (terkawal)
      let base = 0.8;
      let bloomMaxDyn = 1.6;
      const inhaleMul = 1.15;
      const bloomStep = 0.10;

      // Kitaran terhad 3 kali
      const MAX_BREATHS = 3;
      let breathCount = 0;

      // State
      let running = false;

      // ===== Kira had maksimum dinamik (tak tutup tulisan)
      function computeMaxBloom(){
        const flower = document.getElementById('flower');
        const flowerW = flower.offsetWidth, flowerH = flower.offsetHeight;
        const pad = 12;
        const zoneW = zone.clientWidth - pad*2;
        const zoneH = zone.clientHeight - pad*2;
        const targetFit = 0.9 * Math.min(zoneW/flowerW, zoneH/flowerH);
        const maxBaseByFit = targetFit / inhaleMul;
        bloomMaxDyn = Math.max(0.7, Math.min(2.0, maxBaseByFit));
        if(base > bloomMaxDyn){
          base = bloomMaxDyn;
          wrap.style.setProperty('--base', base.toFixed(3));
          updateMeter();
        }
      }
      new ResizeObserver(computeMaxBloom).observe(zone);
      window.addEventListener('load', computeMaxBloom);

      function setPhase(txt){ phaseEl.innerHTML = txt; }
      function setAffirm(txt){ affirmEl.textContent = txt; }
      function updateMeter(){
        const pct = Math.round(((base - 0.8) / (bloomMaxDyn - 0.8)) * 100);
        meterEl.textContent = `Bloom level: ${Math.max(0, Math.min(100, pct))}%`;
      }
      updateMeter();

      function animateToScale(targetScale, duration){
        return new Promise(resolve=>{
          const anim = wrap.animate(
            [{ transform:`scale(${getCurrentScale()})` }, { transform:`scale(${targetScale})` }],
            { duration, easing: 'cubic-bezier(.25,.8,.25,1)', fill:'forwards' }
          );
          anim.onfinish = ()=>{ wrap.style.transform = `scale(${targetScale})`; resolve(); };
        });
      }
      function getCurrentScale(){
        const m = /scale\(([^)]+)\)/.exec(wrap.style.transform||'');
        return m ? parseFloat(m[1]) : base;
      }

      async function doOne478(){
        // clamp base
        base = Math.min(base, bloomMaxDyn);
        wrap.style.setProperty('--base', base.toFixed(3));
        updateMeter();

        // Inhale
        const inhalePeak = Math.min(base*inhaleMul, bloomMaxDyn*inhaleMul);
        setPhase(`Inhale <b>4</b>`);
        await animateToScale(inhalePeak, inhale);

        // Hold
        setPhase(`Hold <b>7</b>`);
        await animateToScale(inhalePeak, hold);

        // Exhale (kembali ke base, stabil)
        setPhase(`Exhale <b>8</b>`);
        await animateToScale(base, exhale);
      }

      async function cycle(){
        if(!running) return;

        await doOne478();
        if(!running) return;

        // Tamat satu kitaran
        breathCount += 1;
        countNumEl.textContent = String(breathCount);

        // mesej kemajuan
        const left = MAX_BREATHS - breathCount;
        if(left === 2) setAffirm("Good — 2 breaths to go.");
        else if(left === 1) setAffirm("Nice — 1 breath to go.");
        else if(left === 0) setAffirm("Well done. You can continue your work now.");

        // naikkan base kecil, hormat had
        base = Math.min(bloomMaxDyn, base + bloomStep);
        wrap.style.setProperty('--base', base.toFixed(3));
        updateMeter();

        // pulse kecil
        wrap.animate(
          [{ transform:`scale(${base})` }, { transform:`scale(${base*1.025})` }, { transform:`scale(${base})` }],
          { duration: 520, easing: 'ease-in-out', fill:'forwards' }
        );

        // hentikan bila capai 3
        if(breathCount >= MAX_BREATHS){
          finishSession();
          return;
        }
        // sambung
        cycle();
      }

      function start(){
        // reset kiraan & mesej
        running = true;
        breathCount = 0;
        countNumEl.textContent = "0";
        setPhase("Take a short rest. Let’s have three good breaths.");
        setAffirm("");
        startBtn.textContent = "Restart";
        pauseBtn.disabled = false;

        // selaraskan transform
        wrap.style.transform = `scale(${base})`;
        cycle();
      }
      function pause(){
        running = false;
        pauseBtn.disabled = true;
        setPhase("Paused");
        wrap.getAnimations().forEach(a => a.cancel());
        wrap.style.transform = `scale(${base})`;
      }
      function resetAll(){
        pause();
        base = 0.8;
        wrap.style.setProperty('--base', base.toFixed(3));
        wrap.style.transform = `scale(${base})`;
        updateMeter();
        setPhase("Take a short rest. Let’s have three good breaths.");
        setAffirm("");
        breathCount = 0;
        countNumEl.textContent = "0";
        startBtn.textContent = "Start";
      }
      function finishSession(){
        running = false;
        pauseBtn.disabled = true;
        setPhase("Session complete");
        wrap.getAnimations().forEach(a => a.cancel());
        wrap.style.transform = `scale(${base})`;
      }

      startBtn.addEventListener('click', ()=>{ pause(); setTimeout(start, 180); });
      pauseBtn.addEventListener('click', pause);
      resetBtn.addEventListener('click', resetAll);

      // Fokus awal
      window.addEventListener('load', ()=> startBtn.focus(), {once:true});
    </script>
  </body>
</html>
