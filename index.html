<!doctype html>
<html lang="ms">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>For Fadhlin â€” Breathe & Bloom (Fixed)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg1:#fff7fb; --bg2:#ffe9f6;
        --text:#161617; --muted:#6a6a6a;
        --pink:#ff4fa0; --pink-soft:#ff86bf;
        --purple:#9b5de5; --purple-dark:#7b3ad7;
      }
      *{box-sizing:border-box}
      html,body{height:100%;margin:0}
      body{
        font-family:Quicksand, system-ui, Segoe UI, Arial, sans-serif;
        background:radial-gradient(80% 80% at 50% 20%, var(--bg2), var(--bg1));
        color:var(--text); overflow:hidden;
        -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      }
      .wrap{position:fixed; inset:0; display:grid; place-items:center; padding:16px}
      .card{
        position:relative; width:min(840px, 92vw); border-radius:22px;
        background:#fff; box-shadow:0 16px 40px rgba(0,0,0,.12);
        padding:28px 18px 22px; overflow:hidden;
      }

      /* butterflies latar lembut (optional kekalkan) */
      .butterflies{position:absolute; inset:0; pointer-events:none; z-index:0}
      .butterfly{
        position:absolute; width:22px; height:16px; opacity:.85;
        top:60%; left:-10%;
        animation:fly linear infinite;
      }
      .butterfly::before, .butterfly::after{
        content:""; position:absolute; top:0; width:12px; height:16px; border-radius:12px;
        background:radial-gradient(circle at 30% 40%, #fff 0 20%, transparent 21%), var(--purple);
        filter:drop-shadow(0 2px 6px rgba(155,93,229,.35));
      }
      .butterfly::before{ left:0; transform-origin:right center; animation:wingL .55s ease-in-out infinite }
      .butterfly::after { right:0; transform-origin:left center;  animation:wingR .55s ease-in-out infinite }
      .butterfly span{ position:absolute; left:9px; top:6px; width:4px; height:6px; background:#6a2fd1; border-radius:2px }
      @keyframes wingL{ 0%,100%{transform:rotate(18deg)} 50%{transform:rotate(2deg)} }
      @keyframes wingR{ 0%,100%{transform:rotate(-18deg)} 50%{transform:rotate(-2deg)} }
      @keyframes fly{ 0%{transform:translate(-12vw, 12vh)} 100%{transform:translate(110vw, -28vh)} }
      .bf1{ top:68%; animation-duration:20s; animation-delay:.2s }
      .bf2{ top:62%; animation-duration:22s; animation-delay:1.1s }
      .bf3{ top:72%; animation-duration:24s; animation-delay:2.0s }

      .title{
        font-family:"Dancing Script", cursive; font-weight:700;
        font-size:clamp(28px,6.4vw,56px); line-height:1.1;
        color:var(--pink); text-align:center; margin:4px 8px 8px;
        text-shadow:0 0 18px rgba(255,79,160,.22);
        animation:fadeDown .7s ease-out both;
      }
      @keyframes fadeDown{ from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)} }

      .sub{ text-align:center; font-weight:700; color:var(--pink-soft); margin:0 0 6px; }
      .hint{ text-align:center; font-size:12px; color:var(--muted); margin:0 0 10px }

      .zone{
        position:relative; display:grid; place-items:center;
        height:min(54vh, 500px); margin:6px 0 8px; z-index:1;
        padding:4px; /* buffer kecil supaya tak sentuh tepi */
      }

      /* bunga */
      .flowerWrap{
        transform:scale(var(--base, .8)); transition:transform .8s cubic-bezier(.25,.8,.25,1);
        filter:drop-shadow(0 14px 28px rgba(155,93,229,.22));
        will-change:transform;
      }
      .flower{
        width:min(360px, 70vmin); aspect-ratio:1/1; position:relative;
        opacity:.98;
      }
      .petal{
        position:absolute; inset:0; display:grid; place-items:center;
        transform:rotate(var(--r,0deg));
      }
      .petal > span{
        width:52%; height:52%;
        border-radius:45% 55% 45% 55% / 55% 45% 55% 45%;
        background:
          radial-gradient(ellipse at 30% 30%, #fff 0 18%, transparent 19%),
          radial-gradient(circle at 70% 70%, rgba(255,255,255,.4) 0 18%, transparent 19%),
          linear-gradient(180deg, rgba(155,93,229,.88), rgba(155,93,229,.68));
        box-shadow:inset 0 0 10px rgba(255,255,255,.25);
      }
      .centerDot{ position:absolute; inset:0; display:grid; place-items:center }
      .centerDot::before{
        content:""; width:22%; aspect-ratio:1; border-radius:50%;
        background:radial-gradient(circle at 35% 35%, #ffe 0 20%, transparent 21%), #7b3ad7;
        box-shadow:0 4px 12px rgba(0,0,0,.15) inset;
      }
      .ring{ position:absolute; inset:6%; border-radius:50%; border:2px dashed rgba(123,58,215,.2) }

      /* teks fasa & afirmasi */
      .phase{ margin-top:10px; text-align:center; font-weight:700; }
      .phase b{ color:var(--purple-dark) }
      .affirm{ text-align:center; font-size:14px; color:#4a4a4a; margin-top:6px; min-height:1.5em }

      .controls{ display:flex; justify-content:center; gap:10px; margin-top:12px; flex-wrap:wrap }
      .btn{
        background:linear-gradient(180deg, #ff8ec4, #ff5ea8);
        color:#fff; border:none; border-radius:999px; padding:10px 16px;
        font-weight:700; cursor:pointer; box-shadow:0 10px 20px rgba(255,94,168,.25);
      }
      .btn.secondary{
        background:#fff; color:#ff5ea8; border:2px solid #ff5ea8;
      }
      .btn:active{ transform:translateY(1px) }

      .meters{
        display:flex; gap:14px; justify-content:center; align-items:center;
        margin-top:6px; flex-wrap:wrap; color:#6a6a6a; font-size:12px;
      }
      .count b{ color:var(--pink) }

      @media (max-width:520px){
        .card{border-radius:18px}
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <!-- butterflies -->
        <div class="butterflies">
          <div class="butterfly bf1"><span></span></div>
          <div class="butterfly bf2"><span></span></div>
          <div class="butterfly bf3"><span></span></div>
        </div>

        <h1 class="title">Semangat Fadhlin</h1>
        <p class="sub">Be happy</p>
        <p class="hint">Tap <b>Start</b>, ikut nafas <b>4-7-8</b>. Bunga mekar makin besar tapi tak tutup tulisan. ðŸŒ¸</p>

        <div class="zone" id="zone">
          <div class="flowerWrap" id="flowerWrap" style="--base:.8">
            <div class="flower" id="flower" aria-label="Breathing flower">
              <!-- 8 kelopak -->
              <div class="petal" style="--r:0deg"><span></span></div>
              <div class="petal" style="--r:45deg"><span></span></div>
              <div class="petal" style="--r:90deg"><span></span></div>
              <div class="petal" style="--r:135deg"><span></span></div>
              <div class="petal" style="--r:180deg"><span></span></div>
              <div class="petal" style="--r:225deg"><span></span></div>
              <div class="petal" style="--r:270deg"><span></span></div>
              <div class="petal" style="--r:315deg"><span></span></div>
              <div class="centerDot"></div>
              <div class="ring"></div>
            </div>
          </div>
        </div>

        <div class="phase" id="phase">Ready?</div>
        <div class="affirm" id="affirm"></div>

        <div class="controls">
          <button class="btn" id="startBtn">Start</button>
          <button class="btn secondary" id="pauseBtn" disabled>Pause</button>
          <button class="btn secondary" id="resetBtn">Reset Bloom</button>
        </div>
        <div class="meters">
          <div class="count" id="count">478 breaths: <b>0</b></div>
          <div class="count" id="meter">Bloom level: 0%</div>
        </div>
      </div>
    </div>

    <script>
      const zone = document.getElementById('zone');
      const wrap = document.getElementById('flowerWrap');
      const phaseEl = document.getElementById('phase');
      const affirmEl = document.getElementById('affirm');
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const resetBtn = document.getElementById('resetBtn');
      const meterEl = document.getElementById('meter');
      const countEl = document.getElementById('count').querySelector('b');

      // Affirmations pendek (boleh kekalkan/kembang)
      const affirmations = [
        "Inhale calmâ€¦ exhale worry.",
        "Youâ€™re safe here.",
        "Soft day, slow steps.",
        "Be gentle with yourself.",
        "Tiny steps still count."
      ];
      let idx = 0;

      // Timing 4-7-8
      const inhale = 4000, hold = 7000, exhale = 8000;

      // Bloom cumulative
      let base = 0.8;                 // skala asas
      let bloomMaxDyn = 1.6;          // akan dikira dinamik ikut skrin
      const inhaleMul = 1.15;         // kembang ketika inhale
      const bloomStep = 0.10;         // naik selepas setiap kitaran
      let breathCount = 0;

      // Running state
      let running = false;

      // ===== Dinamik: kira had maksimum supaya tak tutup tulisan
      function computeMaxBloom(){
        // ukuran fizikal flower asal (tanpa skala)
        const flower = document.getElementById('flower');
        const flowerW = flower.offsetWidth;   // px, pada scale 1
        const flowerH = flower.offsetHeight;  // px

        const pad = 12; // buffer agar tidak sentuh tepi/atas bawah
        const zoneW = zone.clientWidth - pad*2;
        const zoneH = zone.clientHeight - pad*2;

        // ketika puncak inhale, skala = base * inhaleMul. Kita nak puncak <= muat 90% zon (kecilkan lagi).
        const targetFit = 0.9 * Math.min(zoneW/flowerW, zoneH/flowerH);
        // had skala asas (base) supaya base*inhaleMul <= targetFit
        const maxBaseByFit = targetFit / inhaleMul;

        // clamp minimum munasabah (â‰¥0.7) dan maksimum (contoh 2.2)
        bloomMaxDyn = Math.max(0.7, Math.min(2.2, maxBaseByFit));
        // Jika base melebihi had, turunkan sedikit agar exhale stabil
        if(base > bloomMaxDyn) {
          base = bloomMaxDyn;
          wrap.style.setProperty('--base', base.toFixed(3));
          updateMeter();
        }
      }

      // panggil awal & bila resize
      new ResizeObserver(computeMaxBloom).observe(zone);
      window.addEventListener('load', computeMaxBloom);

      // ===== UI helpers
      function setPhase(txt){ phaseEl.innerHTML = txt; }
      function updateMeter(){
        const pct = Math.round(((base - 0.8) / (bloomMaxDyn - 0.8)) * 100);
        meterEl.textContent = `Bloom level: ${Math.max(0, Math.min(100, pct))}%`;
      }
      updateMeter();

      // Animasi skala berasaskan WAAPI, dipromisekan supaya urutan solid
      function animateToScale(targetScale, duration){
        return new Promise(resolve=>{
          const anim = wrap.animate(
            [{ transform:`scale(${getCurrentScale()})` }, { transform:`scale(${targetScale})` }],
            { duration, easing: 'cubic-bezier(.25,.8,.25,1)', fill:'forwards' }
          );
          anim.onfinish = ()=>{ wrap.style.transform = `scale(${targetScale})`; resolve(); };
        });
      }
      function getCurrentScale(){
        // baca terus daripada style var --base (sebab transform final sentiasa set ke base/current)
